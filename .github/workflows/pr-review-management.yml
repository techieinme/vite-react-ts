name: PR Review Management

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  pull_request:
    types: [opened]
  workflow_dispatch:

jobs:
  manage-reviews:
    permissions:
      issues: write
      pull-requests: write
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          npm init -y
          npm install axios

      - name: Get PR Details and Comments
        id: pr-details
        uses: actions/github-script@v7
        with:
          script: |
            let prNumber;
            if (context.eventName === 'pull_request') {
              prNumber = context.payload.pull_request.number;
            } else if (context.eventName === 'issue_comment') {
              if (!context.payload.issue.pull_request) return;
              prNumber = context.payload.issue.number;
            } else if (context.eventName === 'pull_request_review_comment') {
              prNumber = context.payload.pull_request.number;
            } else {
              return;
            }

            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });

            const issueComments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });

            const reviewComments = await github.rest.pulls.listReviewComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });

            const totalComments = issueComments.data.length + reviewComments.data.length;

            return JSON.stringify({
              commentCount: totalComments,
              prUrl: pr.data.html_url,
              title: pr.data.title,
              prNumber: prNumber,
              currentReviewers: pr.data.requested_reviewers?.map(r => r.login) || []
            });

      - name: Manage Reviewers
        if: ${{ steps.pr-details.outputs.result != '' }}
        uses: actions/github-script@v7
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
          COMMENT_THRESHOLD: 5
          PR_DETAILS: ${{ steps.pr-details.outputs.result }}
        with:
          script: |
            const axios = require('axios');
            const prDetails = JSON.parse(process.env.PR_DETAILS);

            const reviewers = {
              senior: [
                {github: 'senior-dev1', slack: 'U123ABC'},
                {github: 'senior-dev2', slack: 'U456DEF'}
              ],
              junior: [
                {github: 'junior-dev1', slack: 'U789GHI'},
                {github: 'junior-dev2', slack: 'U012JKL'}
              ]
            };

            if (prDetails.commentCount > process.env.COMMENT_THRESHOLD) {
              const newReviewers = reviewers.senior
                .map(r => r.github)
                .filter(r => !prDetails.currentReviewers.includes(r));

              if (newReviewers.length > 0) {
                await github.rest.pulls.requestReviewers({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: prDetails.prNumber,
                  reviewers: newReviewers
                });

                const reviewerMentions = newReviewers.map(r => '@' + r).join(' ');
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prDetails.prNumber,
                  body: `High activity detected (${prDetails.commentCount} comments). Adding senior reviewers: ${reviewerMentions}`
                });

                for (const reviewer of reviewers.senior.filter(r => newReviewers.includes(r.github))) {
                  await axios.post(process.env.SLACK_WEBHOOK, {
                    text: `Hey <@${reviewer.slack}>! You've been added as a reviewer to PR: ${prDetails.title}\n${prDetails.prUrl}`
                  });
                }
              }
            }
